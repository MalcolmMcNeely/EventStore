@page "/"
@inherits EventStore.Blazor.EFCore.Postgres.Components.BaseControls.PollingComponentBase
@using EventStore.Blazor.EFCore.Postgres.Components.Controls
@using EventStore.Blazor.EFCore.Postgres.Services.Events
@using EventStore.EFCore.Postgres.Events
@inject IEventService EventService

<PageTitle>Dashboard</PageTitle>

<TrafficLightToolbar/>

<MudPaper Outlined="true">
    <CascadingValue Value="@Events" Name="CEvents">
        <MudStack Row="true" Wrap="Wrap.Wrap" AlignItems="AlignItems.Start">
            <EventStoreTable TableName="$All stream" Stream="$All" @ref="AllStreamTable"/>
            <EventStoreTable TableName="Projection stream" Stream="projection-TrafficLightProjection" @ref="ProjectionTable"/>
            <EventStoreTable TableName="Aggregate root stream" Stream="TrafficLight" @ref="AggregateRootTable"/>
            <CommandTable TableName="Command Audit"/>
        </MudStack>
    </CascadingValue>
</MudPaper>

@code {
    List<EventStreamEntity> Events { get; set; } = new();
    EventStoreTable? AllStreamTable { get; set; }
    EventStoreTable? ProjectionTable { get; set; }
    EventStoreTable? AggregateRootTable { get; set; }

    protected override async Task StartPollingAsync(CancellationToken token)
    {
        while (!token.IsCancellationRequested)
        {
            var (hasNewEvents, newEvents) = await EventService.GetEventsSince(LastPoll, token).ConfigureAwait(false);

            LastPoll = newEvents.LastOrDefault()?.TimeStamp ?? LastPoll;

            if (hasNewEvents)
            {
                Events.AddRange(newEvents);

                await InvokeAsync(async () =>
                {
                    StateHasChanged();
                    await AllStreamTable?.ScrollToBottomAsync()!;
                    await ProjectionTable?.ScrollToBottomAsync()!;
                    await AggregateRootTable?.ScrollToBottomAsync()!;
                });
            }

            await Task.Delay(1000, token);
        }
    }
}